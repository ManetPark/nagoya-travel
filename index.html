<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚˜ê³ ì•¼ ì—¬í–‰ ë©”ì´íŠ¸</title>
    
    <!-- PWA ì„¤ì • -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ğŸ”¥ Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (ë²„ì „ 9.x Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        input:focus, button:focus { outline: none; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================================================================
        // ğŸ”¥ [1ë‹¨ê³„] Firebase ì„¤ì • (ì•„ê¹Œ ë³µì‚¬í•œ ë‚´ìš©ì„ const firebaseConfig = { ... } ì•ˆì— ë®ì–´ì“°ì„¸ìš”)
        // ==========================================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBdFxfq9S355T_IAhoLXtJ9qUrVqnejQfk",
          authDomain: "nagoya-travel-78f5b.firebaseapp.com",
          projectId: "nagoya-travel-78f5b",
          storageBucket: "nagoya-travel-78f5b.firebasestorage.app",
          messagingSenderId: "371849008288",
          appId: "1:371849008288:web:b2b74a2894007d53a665c5",
          measurementId: "G-7FN4YL29BY"
        };

        // Firebase ì´ˆê¸°í™” (ì„¤ì •ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨)
        let db;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        // --- ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ (ìƒëµ ì—†ì´ í¬í•¨) ---
        const IconBase = ({ size = 24, color = "currentColor", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const Calendar = (p) => <IconBase {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></IconBase>;
        const Wallet = (p) => <IconBase {...p}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4v-8z"></path></IconBase>;
        const Languages = (p) => <IconBase {...p}><path d="m5 8 6 6"></path><path d="m4 14 6-6 2-3"></path><path d="M2 5h12"></path><path d="M7 2h1"></path><path d="m22 22-5-10-5 10"></path><path d="M14 18h6"></path></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><polyline points="6 9 12 15 18 9"></polyline></IconBase>;
        const ChevronUp = (p) => <IconBase {...p}><polyline points="18 15 12 9 6 15"></polyline></IconBase>;
        const Coffee = (p) => <IconBase {...p}><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></IconBase>;
        const Utensils = (p) => <IconBase {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></IconBase>;
        const ShoppingBag = (p) => <IconBase {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></IconBase>;
        const Train = (p) => <IconBase {...p}><rect x="2" y="3" width="20" height="14" rx="2"></rect><line x1="8" y1="21" x2="8" y2="17"></line><line x1="16" y1="21" x2="16" y2="17"></line><line x1="12" y1="17" x2="12" y2="3"></line><path d="M2 9h20"></path></IconBase>;
        const Hotel = (p) => <IconBase {...p}><path d="M18 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Z"></path><path d="m9 2 2 2h2l2-2"></path><path d="M22 20h-2V6h2a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z"></path><path d="M4 20H2V6h2a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2Z"></path></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const Volume2 = (p) => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>;
        const Edit = (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const CloudOff = (p) => <IconBase {...p}><line x1="1" y1="1" x2="23" y2="23"></line><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"></path><line x1="1" y1="1" x2="23" y2="23"></line></IconBase>;

        const iconMap = { 'train': Train, 'hotel': Hotel, 'utensils': Utensils, 'mappin': MapPin, 'shoppingbag': ShoppingBag, 'coffee': Coffee };

        // --- Gemini API (ì´ë¯¸ ì„¤ì •ëœ í‚¤ ì‚¬ìš©) ---
        const callGeminiAPI = async (userQuery) => {
            const apiKey = "AIzaSyBn7yNPDQu5KWbrtgLVlvgCwgHQwFUTdBU"; 
            if (!apiKey) return "âš ï¸ API í‚¤ ì˜¤ë¥˜";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemInstruction = "ë‚˜ê³ ì•¼ ì—¬í–‰ ê°€ì´ë“œì…ë‹ˆë‹¤. 3ì¤„ ì´ë‚´ë¡œ ë‹µë³€í•˜ì„¸ìš”.";
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemInstruction }] } };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì˜¤ë¥˜";
            } catch (error) { return "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"; }
        };

        // --- ê¸°ë³¸ ë°ì´í„° (ì²˜ìŒ DBê°€ ë¹„ì—ˆì„ ë•Œë§Œ ì‚¬ìš©) ---
        const defaultItinerary = [
            { id: "day1", day: 1, date: "1ì›” 31ì¼ (ê¸ˆ)", title: "ë‚˜ê³ ì•¼ ë„ì°© & ì‚¬ì¹´ì—", location: "ë‚˜ê³ ì•¼ ì‹œë‚´", activities: [] },
            { id: "day2", day: 2, date: "2ì›” 1ì¼ (í† )", title: "ê·¼êµ: ë‹¤ì¹´ì•¼ë§ˆ & ê²Œë¡œ", location: "ë‹¤ì¹´ì•¼ë§ˆ/ê²Œë¡œ", activities: [] },
            { id: "day3", day: 3, date: "2ì›” 2ì¼ (ì¼)", title: "ë‚˜ê³ ì•¼ ë³µê·€ & ì˜¤ìŠ¤", location: "ë‚˜ê³ ì•¼", activities: [] },
            { id: "day4", day: 4, date: "2ì›” 3ì¼ (ì›”)", title: "ëª¨ë‹ & ê·€êµ­", location: "ë‚˜ê³ ì•¼", activities: [] }
        ];

        const phrases = [
            { k: "ì•ˆë…•í•˜ì„¸ìš”", j: "ã“ã‚“ã«ã¡ã¯", r: "ê³¤ë‹ˆì°Œì™€" }, { k: "ê°ì‚¬í•©ë‹ˆë‹¤", j: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", r: "ì•„ë¦¬ê°€ë˜-ê³ ìì´ë§ˆìŠ¤" },
            { k: "ì–¼ë§ˆì¸ê°€ìš”?", j: "ã„ãã‚‰ã§ã™ã‹ï¼Ÿ", r: "ì´ì¿ ë¼ë°ìŠ¤ê¹Œ?" }, { k: "ì£¼ë¬¸í• ê²Œìš”", j: "æ³¨æ–‡ãŠé¡˜ã„ã—ã¾ã™", r: "ì¶”ëª¬ ì˜¤ë„¤ê°€ì´ì‹œë§ˆìŠ¤" },
        ];

        // --- Components ---
        const Navigation = ({ activeTab, setActiveTab }) => (
            <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-50 h-16 flex justify-around items-center">
                <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center ${activeTab === 'itinerary' ? 'text-indigo-600' : 'text-gray-400'}`}><Calendar size={20} /><span className="text-[10px]">ì¼ì •</span></button>
                <button onClick={() => setActiveTab('ai-guide')} className={`flex flex-col items-center ${activeTab === 'ai-guide' ? 'text-indigo-600' : 'text-gray-400'}`}><Sparkles size={20} /><span className="text-[10px]">AI</span></button>
                <button onClick={() => setActiveTab('translate')} className={`flex flex-col items-center ${activeTab === 'translate' ? 'text-indigo-600' : 'text-gray-400'}`}><Languages size={20} /><span className="text-[10px]">ë²ˆì—­</span></button>
                <button onClick={() => setActiveTab('wallet')} className={`flex flex-col items-center ${activeTab === 'wallet' ? 'text-indigo-600' : 'text-gray-400'}`}><Wallet size={20} /><span className="text-[10px]">ì§€ì¶œ</span></button>
            </nav>
        );

        const Header = ({ title }) => (
            <header className="fixed top-0 left-0 right-0 bg-indigo-600 text-white h-14 flex items-center justify-center px-4 z-50 shadow-md">
                <h1 className="text-lg font-bold">{title}</h1>
            </header>
        );

        // --- ì¼ì • íƒ­ (Firebase ì—°ë™) ---
        const ItineraryView = () => {
            const [itinerary, setItinerary] = useState([]);
            const [expandedDay, setExpandedDay] = useState(1);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentDayId, setCurrentDayId] = useState(null);
            const [editingActivity, setEditingActivity] = useState(null);
            
            // [DB ì‹¤ì‹œê°„ ì—°ë™]
            useEffect(() => {
                if (!db) return;
                // 'nagoya_itinerary' ì»¬ë ‰ì…˜ì„ êµ¬ë…
                const unsubscribe = db.collection('nagoya_itinerary').orderBy('day').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (data.length === 0) {
                        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë°ì´í„° ë„£ê¸°
                        defaultItinerary.forEach(day => db.collection('nagoya_itinerary').doc(day.id).set(day));
                    } else {
                        setItinerary(data);
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleSave = async (formData) => {
                if (!db) return alert("DB ì—°ê²° ì•ˆë¨");
                const dayRef = db.collection('nagoya_itinerary').doc(currentDayId);
                
                // í˜„ì¬ í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const dayDoc = await dayRef.get();
                const currentActivities = dayDoc.data().activities || [];
                
                let newActivities;
                if (editingActivity) {
                    newActivities = currentActivities.map(a => a.id === editingActivity.id ? { ...formData, id: a.id } : a);
                } else {
                    newActivities = [...currentActivities, { ...formData, id: Date.now() }];
                }
                newActivities.sort((a, b) => a.time.localeCompare(b.time));
                
                await dayRef.update({ activities: newActivities });
                setIsModalOpen(false);
            };

            const handleDelete = async () => {
                if (!db || !confirm("ì‚­ì œí• ê¹Œìš”?")) return;
                const dayRef = db.collection('nagoya_itinerary').doc(currentDayId);
                const dayDoc = await dayRef.get();
                const newActivities = dayDoc.data().activities.filter(a => a.id !== editingActivity.id);
                await dayRef.update({ activities: newActivities });
                setIsModalOpen(false);
            };

            // ëª¨ë‹¬ UI (ìƒëµ ì—†ì´ í¬í•¨)
            const EditModal = () => {
                const [form, setForm] = useState(editingActivity || { time: '', title: '', desc: '', icon: 'mappin' });
                return (
                    <div className="fixed inset-0 z-[100] flex items-end justify-center modal-overlay" onClick={() => setIsModalOpen(false)}>
                        <div className="bg-white rounded-t-3xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                            <h3 className="font-bold mb-4 text-lg">{editingActivity ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</h3>
                            <form onSubmit={e => { e.preventDefault(); handleSave(form); }} className="space-y-4">
                                <input type="time" value={form.time} onChange={e => setForm({...form, time: e.target.value})} className="w-full p-3 border rounded-lg" required />
                                <input type="text" value={form.title} onChange={e => setForm({...form, title: e.target.value})} placeholder="ì œëª©" className="w-full p-3 border rounded-lg" required />
                                <input type="text" value={form.desc} onChange={e => setForm({...form, desc: e.target.value})} placeholder="ì„¤ëª…" className="w-full p-3 border rounded-lg" />
                                <div className="grid grid-cols-6 gap-2">
                                    {Object.keys(iconMap).map(k => {
                                        const I = iconMap[k];
                                        return <button key={k} type="button" onClick={() => setForm({...form, icon: k})} className={`p-2 border rounded ${form.icon===k?'bg-indigo-100 border-indigo-500':''}`}><I size={20}/></button>
                                    })}
                                </div>
                                <div className="flex gap-2">
                                    {editingActivity && <button type="button" onClick={handleDelete} className="p-3 bg-red-100 text-red-600 rounded-lg"><Trash2/></button>}
                                    <button type="submit" className="flex-1 p-3 bg-indigo-600 text-white rounded-lg font-bold">ì €ì¥</button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            if (!db) return <div className="pt-20 text-center p-4"><CloudOff size={40} className="mx-auto mb-2 text-gray-400"/><p>DB ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.<br/>index.html íŒŒì¼ì„ ì—´ì–´<br/>firebaseConfigë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p></div>;

            return (
                <div className="pb-20 pt-16 px-4 space-y-4">
                    {itinerary.map(day => (
                        <div key={day.id} className="bg-white rounded-xl overflow-hidden card-shadow">
                            <button onClick={() => setExpandedDay(expandedDay === day.day ? null : day.day)} className="w-full flex justify-between items-center p-4">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold ${expandedDay===day.day?'bg-indigo-600':'bg-gray-400'}`}>Day {day.day}</div>
                                    <div className="text-left"><div className="font-bold">{day.date}</div><div className="text-xs text-gray-500">{day.location}</div></div>
                                </div>
                                {expandedDay === day.day ? <ChevronUp /> : <ChevronDown />}
                            </button>
                            {expandedDay === day.day && (
                                <div className="p-4 border-t bg-gray-50">
                                    <div className="flex justify-between mb-3">
                                        <span className="font-bold text-indigo-800">{day.title}</span>
                                        <button onClick={() => { setCurrentDayId(day.id); setEditingActivity(null); setIsModalOpen(true); }} className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded flex gap-1 items-center"><Plus size={12}/>ì¶”ê°€</button>
                                    </div>
                                    <div className="space-y-4 pl-2 border-l-2 border-gray-200 ml-2">
                                        {day.activities && day.activities.map(act => {
                                            const Icon = iconMap[act.icon] || MapPin;
                                            return (
                                                <div key={act.id} onClick={() => { setCurrentDayId(day.id); setEditingActivity(act); setIsModalOpen(true); }} className="relative pl-4 cursor-pointer group">
                                                    <div className="absolute -left-[5px] top-1 w-3 h-3 bg-indigo-500 rounded-full border-2 border-white"></div>
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <span className="text-xs font-bold text-gray-500 bg-white px-1 rounded border">{act.time}</span>
                                                            <div className="font-bold mt-1">{act.title}</div>
                                                            <div className="text-xs text-gray-500">{act.desc}</div>
                                                        </div>
                                                        <Icon size={16} className="text-indigo-400"/>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {(!day.activities || day.activities.length === 0) && <div className="text-xs text-gray-400 pl-4">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                    {isModalOpen && <EditModal />}
                </div>
            );
        };

        // --- AI ê°€ì´ë“œ (ê¸°ì¡´ ìœ ì§€) ---
        const AIGuideView = () => {
            const [msgs, setMsgs] = useState([{id:1, text:"ë‚˜ê³ ì•¼ ì—¬í–‰ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!", sender:'bot'}]);
            const [txt, setTxt] = useState("");
            const [loading, setLoading] = useState(false);
            const endRef = useRef(null);
            useEffect(()=>endRef.current?.scrollIntoView({behavior:'smooth'}),[msgs]);
            const send = async(e)=>{
                e.preventDefault(); if(!txt.trim()||loading)return;
                setMsgs(p=>[...p,{id:Date.now(),text:txt,sender:'user'}]); setTxt(""); setLoading(true);
                const r = await callGeminiAPI(txt);
                setMsgs(p=>[...p,{id:Date.now()+1,text:r,sender:'bot'}]); setLoading(false);
            };
            return (
                <div className="flex flex-col h-screen pb-20 pt-14 bg-gray-100">
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {msgs.map(m=><div key={m.id} className={`flex ${m.sender==='user'?'justify-end':'justify-start'}`}><div className={`px-4 py-2 rounded-2xl max-w-[80%] ${m.sender==='user'?'bg-indigo-600 text-white':'bg-white'}`}>{m.text}</div></div>)}
                        {loading && <div className="ml-2 text-gray-400">...</div>}
                        <div ref={endRef}/>
                    </div>
                    <form onSubmit={send} className="p-3 bg-white flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 bg-gray-100 rounded-full px-4 py-2" placeholder="ì§ˆë¬¸..."/><button className="bg-indigo-600 text-white p-2 rounded-full"><ArrowRight/></button></form>
                </div>
            );
        };

        // --- ì§€ì¶œ íƒ­ (Firebase ì—°ë™) ---
        const WalletView = () => {
            const [expenses, setExpenses] = useState([]);
            const [form, setForm] = useState({ item: '', amount: '', cat: 'ì‹ë¹„' });
            
            useEffect(() => {
                if (!db) return;
                const unsubscribe = db.collection('nagoya_expenses').orderBy('date', 'desc').onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExpenses(data);
                });
                return () => unsubscribe();
            }, []);

            const add = async (e) => {
                e.preventDefault();
                if (!form.item || !form.amount) return;
                await db.collection('nagoya_expenses').add({
                    ...form, amount: parseInt(form.amount), date: new Date().toLocaleDateString()
                });
                setForm({ ...form, item: '', amount: '' });
            };

            const del = async (id) => {
                if(confirm('ì‚­ì œ?')) await db.collection('nagoya_expenses').doc(id).delete();
            };

            const total = expenses.reduce((s, e) => s + e.amount, 0);

            return (
                <div className="pb-20 pt-16 px-4 h-full flex flex-col">
                    <div className="bg-indigo-600 rounded-2xl p-5 text-white shadow-lg mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 opacity-10 transform translate-x-4 -translate-y-4"><Wallet size={120}/></div>
                        <div className="relative z-10"><p className="text-indigo-200 text-sm font-medium">ì´ ì§€ì¶œ</p><h2 className="text-3xl font-bold">Â¥ {total.toLocaleString()}</h2><p className="text-indigo-200 text-sm">â‰ˆ {(total * 9.1).toLocaleString()} ì›</p></div>
                    </div>
                    <form onSubmit={add} className="bg-white p-4 rounded-xl card-shadow mb-6">
                        <div className="grid grid-cols-5 gap-1 mb-3">{['ì‹ë¹„','ì‡¼í•‘','êµí†µ','ìˆ™ë°•','ê¸°íƒ€'].map(c => <button key={c} type="button" onClick={() => setForm({...form, cat: c})} className={`text-xs py-2 rounded-lg font-medium ${form.cat===c?'bg-indigo-600 text-white':'bg-gray-100 text-gray-500'}`}>{c}</button>)}</div>
                        <div className="space-y-2 mb-3">
                            <input type="text" placeholder="ë‚´ì—­" value={form.item} onChange={e=>setForm({...form, item: e.target.value})} className="w-full bg-gray-50 border rounded-lg px-3 py-3 outline-none"/>
                            <input type="number" placeholder="ê¸ˆì•¡ (ì—”)" value={form.amount} onChange={e=>setForm({...form, amount: e.target.value})} className="w-full bg-gray-50 border rounded-lg px-3 py-3 outline-none"/>
                        </div>
                        <button className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">ì¶”ê°€</button>
                    </form>
                    <div className="flex-1 overflow-auto space-y-2 pb-4">
                        {expenses.map(e => (
                            <div key={e.id} className="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className="text-2xl">{e.cat==='ì‹ë¹„'?'ğŸ½ï¸':e.cat==='ì‡¼í•‘'?'ğŸ›ï¸':e.cat==='êµí†µ'?'ğŸš†':'ğŸ’°'}</div>
                                    <div><div className="font-bold">{e.item}</div><div className="text-xs text-gray-400">{e.cat} | {e.date}</div></div>
                                </div>
                                <div className="flex items-center gap-2"><span className="font-bold">Â¥{e.amount.toLocaleString()}</span><button onClick={()=>del(e.id)} className="text-gray-300"><Trash2 size={16}/></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('itinerary');
            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 font-sans">
                    <Header title={activeTab==='itinerary'?'ë‚˜ê³ ì•¼ ì¼ì •':activeTab==='ai-guide'?'AI ê°€ì´ë“œ':activeTab==='translate'?'ë²ˆì—­':'ê°€ê³„ë¶€'} />
                    <main className="max-w-md mx-auto min-h-screen bg-gray-50 relative">
                        {activeTab === 'itinerary' && <ItineraryView />}
                        {activeTab === 'ai-guide' && <AIGuideView />}
                        {activeTab === 'translate' && <TranslatorView />}
                        {activeTab === 'wallet' && <WalletView />}
                    </main>
                    <Navigation activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
